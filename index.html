<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Clube Gestor 360 - Sistema de Gest√£o Modular</title>
    <meta name="theme-color" content="#0F766E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Nunito Sans', 'system-ui', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#F0FDFA', 100: '#CCFBF1', 200: '#99F6E4', 300: '#5EEAD4', 400: '#2DD4BF', 500: '#14B8A6', 600: '#0D9488', 700: '#0F766E', 800: '#115E59', 900: '#134E4A' },
                    },
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Nunito Sans', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f8fafc; }
        .pb-safe { padding-bottom: max(0.5rem, env(safe-area-inset-bottom, 0px)); }
        @keyframes modal-in { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        @keyframes slide-down { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes timer-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes timer-warning { 0%, 100% { background-color: #fef2f2; } 50% { background-color: #fee2e2; } }
        .animate-modal-in { animation: modal-in 0.25s ease-out forwards; }
        .animate-slide-down { animation: slide-down 0.3s ease-out forwards; }
        .animate-pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        .animate-timer { animation: timer-pulse 1s ease-in-out infinite; }
        .animate-timer-warning { animation: timer-warning 1s ease-in-out infinite; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media (max-width: 768px) { ::-webkit-scrollbar { display: none; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // =============================================
        // CONSTANTES E CONFIGURA√á√ïES GLOBAIS
        // =============================================
        const STATUS_RECURSOS = {
            'Livre': { cor: 'emerald', icone: 'üü¢', label: 'Livre', descricao: 'Dispon√≠vel para uso' },
            'Ocupada': { cor: 'blue', icone: 'üîµ', label: 'Ocupada', descricao: 'Em uso no momento' },
            'Manutencao': { cor: 'amber', icone: 'üü°', label: 'Manuten√ß√£o', descricao: 'Reparo programado' },
            'Reservada': { cor: 'purple', icone: 'üü£', label: 'Reservada', descricao: 'Evento/Torneio' },
            'Interditada': { cor: 'red', icone: 'üî¥', label: 'Interditada', descricao: 'Impr√≥pria para uso' },
            'Limpeza': { cor: 'slate', icone: '‚ö™', label: 'Limpeza', descricao: 'Em limpeza' },
        };

        const TEMPO_AQUECIMENTO = 5; // minutos
        const TEMPO_EXTENSAO = 60; // minutos (+1 hora)
        
        const DIAS_SEMANA = [
            { id: 0, nome: 'Domingo', curto: 'Dom' }, 
            { id: 1, nome: 'Segunda', curto: 'Seg' }, 
            { id: 2, nome: 'Ter√ßa', curto: 'Ter' },
            { id: 3, nome: 'Quarta', curto: 'Qua' }, 
            { id: 4, nome: 'Quinta', curto: 'Qui' }, 
            { id: 5, nome: 'Sexta', curto: 'Sex' }, 
            { id: 6, nome: 'S√°bado', curto: 'S√°b' }
        ];

        // =============================================
        // DADOS INICIAIS DO SISTEMA
        // =============================================
        const initialConfig = {
            nome_clube: 'Clube Esportivo Horizonte',
            pix_chave: 'contato@clubehorizonte.com.br',
            pix_tipo: 'Email',
            punicao_noshow_limite: 3,
            punicao_dias_bloqueio: 7
        };

        const initialModulos = [
            { id: 1, nome: 'T√™nis', icone: 'üéæ', ativo: true, gratuito: true, valor: 0, duracao: 60, antecedencia_maxima: 48, janela_cancelamento: 2, fila_habilitada: true, tipo_fila: 'checkin', antecedencia_fila: 30 },
            { id: 6, nome: 'Beach Tennis', icone: 'üèñÔ∏è', ativo: true, gratuito: true, valor: 0, duracao: 60, antecedencia_maxima: 48, janela_cancelamento: 2, fila_habilitada: true, tipo_fila: 'checkin', antecedencia_fila: 30 },
            { id: 2, nome: 'Futebol', icone: '‚öΩ', ativo: true, gratuito: true, valor: 0, duracao: 90, antecedencia_maxima: 72, janela_cancelamento: 4, fila_habilitada: true, tipo_fila: 'agendamento', antecedencia_fila: 60 },
            { id: 3, nome: 'Quiosque', icone: 'üè†', ativo: true, gratuito: false, valor: 350, duracao: 'Di√°ria', antecedencia_maxima: 720, janela_cancelamento: 48, fila_habilitada: false, tipo_fila: 'checkin', antecedencia_fila: 0 },
            { id: 4, nome: 'Sal√£o de Festas', icone: 'üéâ', ativo: true, gratuito: false, valor: 800, duracao: 'Di√°ria', antecedencia_maxima: 720, janela_cancelamento: 72, fila_habilitada: false, tipo_fila: 'checkin', antecedencia_fila: 0 },
            { id: 5, nome: 'Piscina', icone: 'üèä', ativo: false, gratuito: true, valor: 0, duracao: 120, antecedencia_maxima: 24, janela_cancelamento: 1, fila_habilitada: false, tipo_fila: 'checkin', antecedencia_fila: 15 },
        ];

        const initialRecursos = [
            // T√™nis (1 a 10)
            { id: 1, moduloId: 1, nome: 'Quadra de T√™nis 01', capacidade: 4, status: 'Livre', motivo: null },
            { id: 2, moduloId: 1, nome: 'Quadra de T√™nis 02', capacidade: 4, status: 'Livre', motivo: null },
            { id: 3, moduloId: 1, nome: 'Quadra de T√™nis 03', capacidade: 4, status: 'Manutencao', motivo: 'Troca de rede prevista para sexta' },
            { id: 4, moduloId: 1, nome: 'Quadra de T√™nis 04', capacidade: 4, status: 'Livre', motivo: null },
            { id: 5, moduloId: 1, nome: 'Quadra de T√™nis 05', capacidade: 4, status: 'Livre', motivo: null },
            { id: 6, moduloId: 1, nome: 'Quadra de T√™nis 06', capacidade: 4, status: 'Livre', motivo: null },
            { id: 7, moduloId: 1, nome: 'Quadra de T√™nis 07', capacidade: 4, status: 'Livre', motivo: null },
            { id: 8, moduloId: 1, nome: 'Quadra de T√™nis 08', capacidade: 4, status: 'Livre', motivo: null },
            { id: 9, moduloId: 1, nome: 'Quadra de T√™nis 09', capacidade: 4, status: 'Livre', motivo: null },
            { id: 10, moduloId: 1, nome: 'Quadra de T√™nis 10', capacidade: 4, status: 'Livre', motivo: null },
            // Beach Tennis (11 a 14)
            { id: 11, moduloId: 6, nome: 'Quadra Beach 01', capacidade: 4, status: 'Livre', motivo: null },
            { id: 12, moduloId: 6, nome: 'Quadra Beach 02', capacidade: 4, status: 'Livre', motivo: null },
            { id: 13, moduloId: 6, nome: 'Quadra Beach 03', capacidade: 4, status: 'Livre', motivo: null },
            { id: 14, moduloId: 6, nome: 'Quadra Beach 04', capacidade: 4, status: 'Livre', motivo: null },
            // Futebol e Outros
            { id: 15, moduloId: 2, nome: 'Campo Society 01', capacidade: 14, status: 'Livre', motivo: null },
            { id: 16, moduloId: 2, nome: 'Campo Society 02', capacidade: 14, status: 'Interditada', motivo: 'Gramado molhado' },
            { id: 17, moduloId: 3, nome: 'Quiosque 01', capacidade: 30, status: 'Livre', motivo: null },
            { id: 18, moduloId: 3, nome: 'Quiosque 02', capacidade: 25, status: 'Livre', motivo: null },
            { id: 19, moduloId: 4, nome: 'Sal√£o Principal', capacidade: 150, status: 'Livre', motivo: null },
        ];

        const initialAulas = [
            { id: 1, recursoId: 1, diasSemana: [1, 3], horaInicio: '18:00', horaFim: '20:00', professor: 'Daniel', nome: 'Treino Performance', status: 'ativo' }, 
            { id: 2, recursoId: 2, diasSemana: [2, 4], horaInicio: '09:00', horaFim: '11:00', professor: 'Moacyr', nome: 'Aula Iniciante', status: 'ativo' }, 
            { id: 3, recursoId: 11, diasSemana: [5], horaInicio: '17:00', horaFim: '19:00', professor: 'Xit√£o', nome: 'Beach Pro', status: 'ativo' }, 
        ];

        const initialUsuarios = [
            { id: 1, nome: 'Admin Master', matricula: 'ADM001', senha: '1234', role: 'Admin', status: 'Ativo', noshow_count: 0, bloqueado_ate: null },
            { id: 2, nome: 'Jo√£o Recep√ß√£o', matricula: 'FUNC001', senha: '1234', role: 'Funcionario', status: 'Ativo', noshow_count: 0, bloqueado_ate: null },
            { id: 3, nome: 'Maria Silva', matricula: 'SOC001', senha: '1234', role: 'Socio', status: 'Ativo', noshow_count: 0, bloqueado_ate: null },
            { id: 4, nome: 'Carlos Santos', matricula: 'SOC002', senha: '1234', role: 'Socio', status: 'Bloqueado', noshow_count: 2, bloqueado_ate: '2025-12-31' },
            { id: 5, nome: 'Ana Oliveira', matricula: 'SOC003', senha: '1234', role: 'Socio', status: 'Ativo', noshow_count: 0, bloqueado_ate: null },
            { id: 6, nome: 'Pedro Costa', matricula: 'SOC004', senha: '1234', role: 'Socio', status: 'Ativo', noshow_count: 1, bloqueado_ate: null },
            { id: 7, nome: 'Lucia Ferreira', matricula: 'SOC005', senha: '1234', role: 'Socio', status: 'Cancelado', noshow_count: 0, bloqueado_ate: null },
        ];

        // =============================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // =============================================
        const formatDate = (date) => date.toISOString().split('T')[0];
        const hoje = () => formatDate(new Date());
        const formatDateBR = (str) => { if (!str) return ''; const [y, m, d] = str.split('-'); return `${d}/${m}/${y}`; };
        const formatarTempo = (segundos) => {
            if (segundos <= 0) return '00:00';
            const mins = Math.floor(segundos / 60);
            const secs = segundos % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        };
        const gerarHorarios = () => {
            const h = [];
            for (let i = 6; i < 22; i++) { h.push(`${String(i).padStart(2, '0')}:00`); h.push(`${String(i).padStart(2, '0')}:30`); }
            return h;
        };
        const getHoraAtualArredondada = () => {
            const now = new Date();
            let h = now.getHours();
            let m = now.getMinutes();
            if (m > 30) { h += 1; m = 0; } else if (m > 0) { m = 30; }
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };
        const calcularHoraFim = (horaInicio, duracaoMin) => {
            const [h, m] = horaInicio.split(':').map(Number);
            const totalMin = h * 60 + m + duracaoMin;
            return `${String(Math.floor(totalMin / 60)).padStart(2, '0')}:${String(totalMin % 60).padStart(2, '0')}`;
        };
        const addDays = (date, days) => { const r = new Date(date); r.setDate(r.getDate() + days); return r; };

        const temConflitoHorario = (h1Inicio, h1Fim, h2Inicio, h2Fim) => {
            const [i1H, i1M] = h1Inicio.split(':').map(Number);
            const [f1H, f1M] = h1Fim.split(':').map(Number);
            const [i2H, i2M] = h2Inicio.split(':').map(Number);
            const [f2H, f2M] = h2Fim.split(':').map(Number);
            const minI1 = i1H * 60 + i1M;
            const minF1 = f1H * 60 + f1M;
            const minI2 = i2H * 60 + i2M;
            const minF2 = f2H * 60 + f2M;
            return (minI1 < minF2 && minF1 > minI2);
        };
        
        const formatDiasSemana = (dias) => {
            if (!dias || dias.length === 0) return 'Nenhum dia';
            if (dias.length === 7) return 'Todos os dias';
            if (dias.length === 5 && dias.includes(1) && dias.includes(5) && !dias.includes(0) && !dias.includes(6)) return 'Segunda a Sexta';
            return dias.sort().map(d => DIAS_SEMANA.find(ds => ds.id === d)?.curto).join(', ');
        };

        // =============================================
        // COMPONENTES DE UI
        // =============================================
        const Card = ({ children, className = '', onClick }) => (
            <div className={`bg-white rounded-2xl shadow-sm border border-slate-100 ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''} ${className}`} onClick={onClick}>{children}</div>
        );

        const Button = ({ children, variant = 'primary', size = 'md', className = '', ...props }) => {
            const variants = {
                primary: 'bg-teal-600 hover:bg-teal-700 text-white shadow-sm',
                secondary: 'bg-slate-100 hover:bg-slate-200 text-slate-700',
                danger: 'bg-red-500 hover:bg-red-600 text-white',
                success: 'bg-emerald-500 hover:bg-emerald-600 text-white',
                warning: 'bg-amber-500 hover:bg-amber-600 text-white',
                ghost: 'hover:bg-slate-100 text-slate-600',
                purple: 'bg-purple-500 hover:bg-purple-600 text-white',
                blue: 'bg-blue-500 hover:bg-blue-600 text-white',
            };
            const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2.5 text-sm', lg: 'px-6 py-3 text-base' };
            return <button className={`font-semibold rounded-xl transition-all duration-200 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${sizes[size]} ${className}`} {...props}>{children}</button>;
        };

        const Badge = ({ children, variant = 'default', size = 'md' }) => {
            const variants = { default: 'bg-slate-100 text-slate-700', success: 'bg-emerald-100 text-emerald-700', warning: 'bg-amber-100 text-amber-700', danger: 'bg-red-100 text-red-700', info: 'bg-blue-100 text-blue-700', purple: 'bg-purple-100 text-purple-700', emerald: 'bg-emerald-100 text-emerald-700', blue: 'bg-blue-100 text-blue-700', amber: 'bg-amber-100 text-amber-700', red: 'bg-red-100 text-red-700', slate: 'bg-slate-200 text-slate-600' };
            const sizes = { sm: 'px-2 py-0.5 text-xs', md: 'px-2.5 py-1 text-xs' };
            return <span className={`font-semibold rounded-full ${variants[variant]} ${sizes[size]}`}>{children}</span>;
        };

        const Toggle = ({ checked, onChange, label }) => (
            <label className="flex items-center gap-3 cursor-pointer">
                <div className="relative">
                    <input type="checkbox" checked={checked} onChange={(e) => onChange(e.target.checked)} className="sr-only" />
                    <div className={`w-12 h-6 rounded-full transition-colors ${checked ? 'bg-teal-500' : 'bg-slate-300'}`}>
                        <div className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow-sm transition-transform ${checked ? 'translate-x-6' : ''}`} />
                    </div>
                </div>
                {label && <span className="text-sm font-medium text-slate-700">{label}</span>}
            </label>
        );

        const Input = ({ label, error, ...props }) => (
            <div className="space-y-1.5">
                {label && <label className="text-sm font-medium text-slate-700">{label}</label>}
                <input className={`w-full px-4 py-2.5 rounded-xl border ${error ? 'border-red-300' : 'border-slate-200'} focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 outline-none transition-all text-slate-800`} {...props} />
                {error && <p className="text-sm text-red-500">{error}</p>}
            </div>
        );

        const Select = ({ label, options, ...props }) => (
            <div className="space-y-1.5">
                {label && <label className="text-sm font-medium text-slate-700">{label}</label>}
                <select className="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 outline-none transition-all text-slate-800 bg-white" {...props}>
                    {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                </select>
            </div>
        );

        const Textarea = ({ label, ...props }) => (
            <div className="space-y-1.5">
                {label && <label className="text-sm font-medium text-slate-700">{label}</label>}
                <textarea className="w-full px-4 py-2.5 rounded-xl border border-slate-200 focus:border-teal-500 focus:ring-2 focus:ring-teal-500/20 outline-none transition-all text-slate-800 resize-none" rows={3} {...props} />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children, size = 'md' }) => {
            if (!isOpen) return null;
            const sizes = { sm: 'max-w-sm', md: 'max-w-lg', lg: 'max-w-2xl', xl: 'max-w-4xl' };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onClick={onClose} />
                    <div className={`relative bg-white rounded-2xl shadow-xl w-full ${sizes[size]} max-h-[90vh] overflow-hidden animate-modal-in`}>
                        <div className="flex items-center justify-between p-4 border-b border-slate-100">
                            <h3 className="text-lg font-bold text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-500">‚úï</button>
                        </div>
                        <div className="p-4 overflow-y-auto max-h-[calc(90vh-80px)]">{children}</div>
                    </div>
                </div>
            );
        };

        const TabBar = ({ tabs, active, onChange }) => (
            <div className="flex bg-slate-100 rounded-xl p-1 overflow-x-auto">
                {tabs.map(tab => (
                    <button key={tab.id} onClick={() => onChange(tab.id)} className={`flex-1 px-3 py-2 rounded-lg text-sm font-semibold transition-all whitespace-nowrap ${active === tab.id ? 'bg-white text-teal-700 shadow-sm' : 'text-slate-600 hover:text-slate-800'}`}>{tab.label}</button>
                ))}
            </div>
        );

        const Notification = ({ message, type, onClose }) => {
            useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, [onClose]);
            const colors = { success: 'bg-emerald-500', warning: 'bg-amber-500', error: 'bg-red-500', info: 'bg-blue-500' };
            return <div className={`fixed top-4 left-4 right-4 z-50 p-4 rounded-xl text-white font-medium shadow-lg animate-slide-down ${colors[type] || colors.info}`}>{message}</div>;
        };

        const StatusRecursoBadge = ({ status, size = 'md' }) => {
            const cfg = STATUS_RECURSOS[status] || STATUS_RECURSOS['Livre'];
            return <Badge variant={cfg.cor} size={size}>{cfg.icone} {cfg.label}</Badge>;
        };

        const StatusReservaBadge = ({ status }) => {
            const config = {
                'Pendente': { variant: 'warning', label: 'Aguardando Check-in' },
                'Confirmada': { variant: 'info', label: 'Confirmada' },
                'Em Andamento': { variant: 'success', label: 'Em Andamento' },
                'Finalizada': { variant: 'default', label: 'Finalizada' },
                'Cancelada': { variant: 'danger', label: 'Cancelada' },
                'No-Show': { variant: 'danger', label: 'No-Show' },
                'Aguardando Pagamento': { variant: 'purple', label: 'Aguardando Pagamento' },
            };
            const { variant, label } = config[status] || { variant: 'default', label: status };
            return <Badge variant={variant}>{label}</Badge>;
        };

        // =============================================
        // COMPONENTES PRINCIPAIS
        // =============================================
        const Header = ({ user, onLogout }) => (
            <header className="bg-white border-b border-slate-100 sticky top-0 z-40">
                <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">C</div>
                        <div>
                            <h1 className="font-bold text-slate-800 leading-tight">Clube Gestor 360</h1>
                            <p className="text-xs text-slate-500">{user.nome}</p>
                        </div>
                    </div>
                    <div className="flex items-center gap-2">
                        <Badge variant={user.role === 'Admin' ? 'purple' : user.role === 'Funcionario' ? 'info' : 'success'}>{user.role}</Badge>
                        <button onClick={onLogout} className="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-500" title="Sair">üö™</button>
                    </div>
                </div>
            </header>
        );

        const BottomNav = ({ view, onNavigate, role }) => {
            const items = [
                { id: 'home', icon: 'üè†', label: 'In√≠cio' },
                { id: 'reservas', icon: 'üìÖ', label: 'Minhas Reservas' }, // Alterado Label
                { id: 'fila', icon: '‚è≥', label: 'Fila' },
                ...(role !== 'Socio' ? [{ id: 'lousa', icon: 'üìã', label: 'Lousa' }] : []),
                ...(role === 'Admin' || role === 'Funcionario' ? [{ id: 'config', icon: '‚öôÔ∏è', label: 'Config' }] : []),
            ];
            return (
                <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 pb-safe z-40">
                    <div className="flex justify-around py-2">
                        {items.map(item => (
                            <button key={item.id} onClick={() => onNavigate(item.id)} className={`flex flex-col items-center gap-1 px-2 py-2 rounded-xl transition-colors ${view === item.id ? 'text-teal-600' : 'text-slate-400 hover:text-slate-600'}`}>
                                <span className="text-lg">{item.icon}</span>
                                <span className="text-xs font-medium">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </nav>
            );
        };

        // TELA DE LOGIN
        const TelaLogin = ({ usuarios, onLogin }) => {
            const [matricula, setMatricula] = useState('');
            const [senha, setSenha] = useState('');
            const [erro, setErro] = useState('');

            const handleLogin = () => {
                const user = usuarios.find(u => u.matricula.toLowerCase() === matricula.toLowerCase() && u.senha === senha);
                if (user) {
                    if (user.status === 'Cancelado') {
                        setErro('Acesso revogado. Contate a administra√ß√£o.');
                        return;
                    }
                    if (user.bloqueado_ate && new Date(user.bloqueado_ate) > new Date()) {
                        setErro(`Usu√°rio bloqueado at√© ${formatDateBR(user.bloqueado_ate)}`);
                        return;
                    }
                    onLogin(user);
                } else {
                    setErro('Matr√≠cula ou senha inv√°lidos');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-teal-500 to-emerald-600 flex items-center justify-center p-4">
                    <Card className="w-full max-w-sm p-6">
                        <div className="text-center mb-6">
                            <div className="w-16 h-16 bg-gradient-to-br from-teal-500 to-emerald-600 rounded-2xl flex items-center justify-center text-white font-bold text-2xl mx-auto mb-4">C</div>
                            <h1 className="text-xl font-bold text-slate-800">Clube Gestor 360</h1>
                            <p className="text-sm text-slate-500">Entre com sua matr√≠cula</p>
                        </div>
                        <div className="space-y-4">
                            <Input label="Matr√≠cula" placeholder="Ex: SOC001" value={matricula} onChange={(e) => { setMatricula(e.target.value.toUpperCase()); setErro(''); }} onKeyPress={(e) => e.key === 'Enter' && handleLogin()} />
                            <Input type="password" label="Senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={senha} onChange={(e) => { setSenha(e.target.value); setErro(''); }} onKeyPress={(e) => e.key === 'Enter' && handleLogin()} />
                            {erro && <div className="p-3 bg-red-50 border border-red-200 rounded-xl"><p className="text-red-600 text-sm text-center">{erro}</p></div>}
                            <Button className="w-full" onClick={handleLogin}>Entrar</Button>
                        </div>
                        <div className="mt-6 p-4 bg-slate-50 rounded-xl">
                            <p className="text-xs text-slate-500 text-center mb-2 font-semibold">üîë Usu√°rios de demonstra√ß√£o:</p>
                            <div className="text-xs text-slate-600 space-y-1">
                                <div className="flex justify-between"><span><strong>ADM001</strong></span><span className="text-purple-600">Admin</span></div>
                                <div className="flex justify-between"><span><strong>FUNC001</strong></span><span className="text-blue-600">Funcion√°rio</span></div>
                                <div className="flex justify-between"><span><strong>SOC001 a SOC005</strong></span><span className="text-emerald-600">S√≥cios</span></div>
                                <p className="text-slate-400 text-center pt-2">Senha para todos: <strong>1234</strong></p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // HOME DO S√ìCIO
        const HomeSocio = ({ modulos, recursos, user, config, onSelectModulo }) => {
            const modulosAtivos = modulos.filter(m => m.ativo);
            const getStats = (moduloId) => {
                const recs = recursos.filter(r => r.moduloId === moduloId);
                return { total: recs.length, livres: recs.filter(r => r.status === 'Livre').length };
            };
            const estaBloqueado = user.bloqueado_ate && new Date(user.bloqueado_ate) > new Date();

            return (
                <div className="p-4 space-y-4 pb-24">
                    <div>
                        <h2 className="text-xl font-bold text-slate-800">Ol√°, {user.nome.split(' ')[0]}! üëã</h2>
                        <p className="text-slate-500">O que voc√™ quer fazer hoje?</p>
                    </div>
                    {estaBloqueado && (
                        <Card className="p-4 bg-red-50 border-red-200">
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">üö´</span>
                                <div>
                                    <p className="font-semibold text-red-800">Conta Bloqueada</p>
                                    <p className="text-sm text-red-600">Voc√™ est√° bloqueado at√© {formatDateBR(user.bloqueado_ate)}.</p>
                                </div>
                            </div>
                        </Card>
                    )}
                    {!estaBloqueado && user.noshow_count > 0 && (
                        <Card className="p-4 bg-amber-50 border-amber-200">
                            <div className="flex items-center gap-3">
                                <span className="text-2xl">‚ö†Ô∏è</span>
                                <div>
                                    <p className="font-semibold text-amber-800">Aten√ß√£o</p>
                                    <p className="text-sm text-amber-600">Voc√™ tem {user.noshow_count}/{config.punicao_noshow_limite} no-shows. Mais {config.punicao_noshow_limite - user.noshow_count} e ser√° bloqueado.</p>
                                </div>
                            </div>
                        </Card>
                    )}
                    <div className="grid grid-cols-2 gap-3">
                        {modulosAtivos.map(modulo => {
                            const { total, livres } = getStats(modulo.id);
                            return (
                                <Card key={modulo.id} className={`p-4 text-center ${estaBloqueado ? 'opacity-50' : ''}`} onClick={estaBloqueado ? undefined : () => onSelectModulo(modulo)}>
                                    <span className="text-4xl mb-2 block">{modulo.icone}</span>
                                    <h3 className="font-semibold text-slate-800">{modulo.nome}</h3>
                                    <p className="text-xs text-slate-500 mt-1">{modulo.gratuito ? 'Gratuito' : `R$ ${modulo.valor}`}</p>
                                    <div className="flex items-center justify-center gap-1 mt-2">
                                        <span className={`w-2 h-2 rounded-full ${livres > 0 ? 'bg-emerald-500' : 'bg-red-500'} animate-pulse-dot`}></span>
                                        <span className="text-xs text-slate-500">{livres}/{total} livres</span>
                                    </div>
                                    {modulo.fila_habilitada && <div className="mt-2"><Badge variant="purple" size="sm">‚è≥ Fila dispon√≠vel</Badge></div>}
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // TELA DE RESERVA
        const TelaReserva = ({ modulo, recursos, reservas, aulas, user, config, onReservar, onVoltar, onEntrarFila }) => {
            const [step, setStep] = useState('recurso');
            const [recursoSelecionado, setRecursoSelecionado] = useState(null);
            const [dataSelecionada, setDataSelecionada] = useState(hoje());
            const [horarioSelecionado, setHorarioSelecionado] = useState(null);
            const [comprovante, setComprovante] = useState(null);
            const isCheckinMode = modulo.tipo_fila === 'checkin';

            useEffect(() => { if (isCheckinMode && step === 'data') { setDataSelecionada(hoje()); setStep('horario'); } }, [step, isCheckinMode]);

            const recursosLivres = recursos.filter(r => r.moduloId === modulo.id && r.status === 'Livre');
            const recursosIndisponiveis = recursos.filter(r => r.moduloId === modulo.id && r.status !== 'Livre');

            const horariosDisponiveis = recursoSelecionado ? gerarHorarios().filter(horario => {
                const duracaoTotal = typeof modulo.duracao === 'number' ? modulo.duracao + TEMPO_AQUECIMENTO : 480;
                const horaFim = calcularHoraFim(horario, duracaoTotal);
                const [hFim] = horaFim.split(':').map(Number);
                if (hFim > 22) return false;
                
                const temReserva = reservas.some(r => {
                    if (r.recursoId !== recursoSelecionado.id || r.data !== dataSelecionada) return false;
                    if (['Cancelada', 'No-Show', 'Finalizada'].includes(r.status)) return false;
                    return temConflitoHorario(horario, horaFim, r.horaInicio, r.horaFim);
                });

                const dt = new Date(dataSelecionada + 'T12:00:00'); 
                const diaDaSemanaReal = dt.getDay();

                const temAula = aulas.some(aula => {
                    if (aula.status === 'cancelada') return false; 
                    if (aula.recursoId !== recursoSelecionado.id) return false;
                    if (!aula.diasSemana.includes(diaDaSemanaReal)) return false;
                    return temConflitoHorario(horario, horaFim, aula.horaInicio, aula.horaFim);
                });

                return !temReserva && !temAula;
            }) : [];

            const handleConfirmar = () => {
                const duracaoTotal = typeof modulo.duracao === 'number' ? modulo.duracao + TEMPO_AQUECIMENTO : 480;
                const horaFinalUso = isCheckinMode ? getHoraAtualArredondada() : horarioSelecionado;
                const horaFim = calcularHoraFim(horaFinalUso, duracaoTotal);
                onReservar({ id: Date.now(), recursoId: recursoSelecionado.id, usuarioId: user.id, data: dataSelecionada, horaInicio: horaFinalUso, horaFim, status: modulo.gratuito ? 'Pendente' : 'Aguardando Pagamento', comprovante_url: comprovante, valor: modulo.valor, iniciadaEm: null, duracaoTotal, criadaEm: new Date().toISOString() });
            };

            const handleCheckinImediato = () => { const agora = getHoraAtualArredondada(); setHorarioSelecionado(agora); setStep(modulo.gratuito ? 'confirmar' : 'pagamento'); };

            return (
                <div className="p-4 space-y-4 pb-24">
                    <button onClick={onVoltar} className="flex items-center gap-2 text-slate-600 font-medium">‚Üê Voltar</button>
                    <div className="flex items-center gap-3"><span className="text-3xl">{modulo.icone}</span><div><h2 className="text-xl font-bold text-slate-800">{modulo.nome}</h2><p className="text-sm text-slate-500">{modulo.gratuito ? 'Gratuito' : `R$ ${modulo.valor}`}{typeof modulo.duracao === 'number' && ` ‚Ä¢ ${modulo.duracao}min + ${TEMPO_AQUECIMENTO}min aquec.`}</p></div></div>
                    {modulo.fila_habilitada && (<Card className="p-4 bg-purple-50 border border-purple-200"><div className="flex items-center justify-between"><div><h4 className="font-semibold text-purple-800">‚è≥ Fila de Espera</h4><p className="text-sm text-purple-600">{modulo.tipo_fila === 'checkin' ? 'Check-in presencial' : 'Agende sua posi√ß√£o'}</p></div><Button variant="purple" size="sm" onClick={() => onEntrarFila(modulo)}>Entrar na Fila</Button></div></Card>)}
                    {step === 'recurso' && (<div className="space-y-3"><h3 className="font-semibold text-slate-700">Escolha o local:</h3>{recursosLivres.length === 0 ? (<Card className="p-6 text-center bg-amber-50"><p className="text-amber-700 mb-3">Nenhum recurso dispon√≠vel.</p>{modulo.fila_habilitada && <Button variant="purple" size="sm" onClick={() => onEntrarFila(modulo)}>Entrar na Fila</Button>}</Card>) : recursosLivres.map(recurso => (<Card key={recurso.id} className={`p-4 border-2 transition-all ${recursoSelecionado?.id === recurso.id ? 'border-teal-500 bg-teal-50' : 'border-transparent hover:border-slate-200'}`} onClick={() => setRecursoSelecionado(recurso)}><div className="flex items-center justify-between"><div><h4 className="font-semibold text-slate-800">{recurso.nome}</h4><div className="flex items-center gap-2 mt-1"><StatusRecursoBadge status={recurso.status} size="sm" /><span className="text-sm text-slate-500">‚Ä¢ {recurso.capacidade} pessoas</span></div></div>{recursoSelecionado?.id === recurso.id && <div className="w-6 h-6 bg-teal-500 rounded-full flex items-center justify-center text-white">‚úì</div>}</div></Card>))}{recursosIndisponiveis.length > 0 && (<div className="pt-4 border-t border-slate-100"><p className="text-sm text-slate-500 mb-2">Indispon√≠veis:</p>{recursosIndisponiveis.map(recurso => (<div key={recurso.id} className="p-3 bg-slate-50 rounded-xl mb-2 opacity-60"><div className="flex items-center justify-between"><span className="text-slate-600">{recurso.nome}</span><StatusRecursoBadge status={recurso.status} size="sm" /></div></div>))}</div>)}{recursosLivres.length > 0 && <Button className="w-full" disabled={!recursoSelecionado} onClick={() => setStep(isCheckinMode ? 'horario' : 'data')}>Continuar</Button>}</div>)}
                    {step === 'data' && !isCheckinMode && (<div className="space-y-3"><h3 className="font-semibold text-slate-700">Escolha a data:</h3><Input type="date" value={dataSelecionada} onChange={(e) => setDataSelecionada(e.target.value)} min={hoje()} /><div className="bg-blue-50 p-3 rounded-xl text-sm text-blue-700">‚è∞ Anteced√™ncia m√°xima: {modulo.antecedencia_maxima}h</div><div className="flex gap-2"><Button variant="secondary" onClick={() => setStep('recurso')}>Voltar</Button><Button className="flex-1" onClick={() => setStep('horario')}>Continuar</Button></div></div>)}
                    {step === 'horario' && (<div className="space-y-3"><h3 className="font-semibold text-slate-700">{isCheckinMode ? 'Confirma√ß√£o de Entrada' : 'Escolha o hor√°rio:'}</h3><p className="text-sm text-slate-500">{recursoSelecionado.nome} ‚Ä¢ {formatDateBR(dataSelecionada)}</p>{isCheckinMode ? (<div className="space-y-4 py-4"><Card className="p-6 text-center bg-teal-50 border border-teal-200"><p className="text-lg font-bold text-teal-900 mb-2">Entrada Imediata</p><p className="text-teal-700 text-sm mb-4">Voc√™ est√° prestes a fazer check-in agora.</p><div className="text-3xl font-mono text-teal-800 font-bold mb-4">{getHoraAtualArredondada()}</div><Button className="w-full" onClick={handleCheckinImediato}>Fazer Check-in Agora</Button></Card><p className="text-xs text-center text-slate-400">O hor√°rio √© registrado automaticamente.</p></div>) : (<>{horariosDisponiveis.length === 0 ? (<Card className="p-6 text-center bg-amber-50"><p className="text-amber-700">Nenhum hor√°rio dispon√≠vel.</p>{modulo.fila_habilitada && <Button variant="purple" size="sm" className="mt-3" onClick={() => onEntrarFila(modulo)}>Entrar na Fila</Button>}</Card>) : (<div className="grid grid-cols-4 gap-2 max-h-64 overflow-y-auto">{horariosDisponiveis.map(horario => (<button key={horario} onClick={() => setHorarioSelecionado(horario)} className={`p-2 rounded-xl text-sm font-medium transition-all ${horarioSelecionado === horario ? 'bg-teal-500 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}>{horario}</button>))}</div>)}</>)}<div className="flex gap-2"><Button variant="secondary" onClick={() => setStep(isCheckinMode ? 'recurso' : 'data')}>Voltar</Button>{!isCheckinMode && <Button className="flex-1" disabled={!horarioSelecionado} onClick={() => setStep(modulo.gratuito ? 'confirmar' : 'pagamento')}>Continuar</Button>}</div></div>)}
                    {step === 'pagamento' && (<div className="space-y-4"><h3 className="font-semibold text-slate-700">Pagamento via PIX:</h3><Card className="p-4 bg-slate-50"><p className="text-sm text-slate-500 mb-2">Valor:</p><p className="text-3xl font-bold text-slate-800">R$ {modulo.valor},00</p></Card><Card className="p-4"><p className="text-sm text-slate-500 mb-2">Chave PIX ({config.pix_tipo}):</p><div className="flex items-center gap-2"><code className="flex-1 bg-slate-100 px-3 py-2 rounded-lg text-sm font-mono truncate">{config.pix_chave}</code><Button variant="secondary" size="sm" onClick={() => navigator.clipboard?.writeText(config.pix_chave)}>Copiar</Button></div></Card><div><label className="block text-sm font-medium text-slate-700 mb-2">Upload do Comprovante:</label><div className="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:border-teal-400 transition-colors"><input type="file" accept="image/*" onChange={(e) => setComprovante(e.target.files?.[0]?.name || null)} className="hidden" id="comprovante" /><label htmlFor="comprovante" className="cursor-pointer">{comprovante ? (<div className="text-emerald-600"><p className="text-2xl mb-2">‚úÖ</p><p className="font-medium">{comprovante}</p><p className="text-sm">Clique para trocar</p></div>) : (<div className="text-slate-400"><p className="text-2xl mb-2">üìé</p><p className="font-medium">Clique para anexar</p><p className="text-sm">JPG, PNG ou PDF</p></div>)}</label></div></div><div className="flex gap-2"><Button variant="secondary" onClick={() => setStep('horario')}>Voltar</Button><Button className="flex-1" disabled={!comprovante} onClick={() => setStep('confirmar')}>Continuar</Button></div></div>)}
                    {step === 'confirmar' && (<div className="space-y-4"><h3 className="font-semibold text-slate-700">Confirme sua reserva:</h3><Card className="p-4 space-y-3"><div className="flex justify-between"><span className="text-slate-500">Local:</span><span className="font-medium text-slate-800">{recursoSelecionado.nome}</span></div><div className="flex justify-between"><span className="text-slate-500">Data:</span><span className="font-medium text-slate-800">{formatDateBR(dataSelecionada)}</span></div><div className="flex justify-between"><span className="text-slate-500">Hor√°rio:</span><span className="font-medium text-slate-800">{horarioSelecionado || getHoraAtualArredondada()} - {calcularHoraFim(horarioSelecionado || getHoraAtualArredondada(), (typeof modulo.duracao === 'number' ? modulo.duracao : 60) + TEMPO_AQUECIMENTO)}</span></div><div className="flex justify-between"><span className="text-slate-500">Dura√ß√£o:</span><span className="font-medium text-slate-800">{typeof modulo.duracao === 'number' ? `${modulo.duracao}min + ${TEMPO_AQUECIMENTO}min aquec.` : 'Di√°ria'}</span></div><div className="flex justify-between"><span className="text-slate-500">Valor:</span><span className="font-medium text-slate-800">{modulo.gratuito ? 'Gratuito' : `R$ ${modulo.valor},00`}</span></div></Card><div className="flex gap-2"><Button variant="secondary" onClick={() => setStep(modulo.gratuito ? 'horario' : 'pagamento')}>Voltar</Button><Button className="flex-1" onClick={handleConfirmar}>‚úì Confirmar Reserva</Button></div></div>)}
                </div>
            );
        };

        // MINHAS RESERVAS UNIFICADA (ATUALIZADO)
        const MinhasReservas = ({ reservas, fila, recursos, modulos, user, onCancelar, onCancelarFila }) => {
            const [tab, setTab] = useState('ativas');
            
            // FILTROS DE RESERVAS
            const minhasReservas = reservas.filter(r => r.usuarioId === user.id);
            const reservasAtivas = minhasReservas.filter(r => r.data >= hoje() && !['Cancelada', 'No-Show', 'Finalizada'].includes(r.status));
            const reservasHistorico = minhasReservas.filter(r => r.data < hoje() || ['Cancelada', 'No-Show', 'Finalizada'].includes(r.status));

            // FILTROS DE FILA
            const minhaFilaAtiva = fila.filter(f => f.usuarioId === user.id && f.status === 'Aguardando');
            const minhaFilaHistorico = fila.filter(f => f.usuarioId === user.id && ['Cancelado', 'Atendido'].includes(f.status));

            // FUN√á√ÉO PARA CALCULAR POSI√á√ÉO REAL NA FILA (FIXED)
            const getPosicaoFila = (itemFila) => {
                const filaDoModulo = fila.filter(f => f.moduloId === itemFila.moduloId && f.status === 'Aguardando').sort((a, b) => new Date(a.criadoEm) - new Date(b.criadoEm));
                return filaDoModulo.findIndex(f => f.id === itemFila.id) + 1;
            };

            const listaAtivas = [
                ...reservasAtivas.map(r => ({...r, tipo: 'reserva', dataSort: r.data + r.horaInicio})),
                ...minhaFilaAtiva.map(f => ({...f, tipo: 'fila', dataSort: f.data + f.horario}))
            ].sort((a, b) => a.dataSort.localeCompare(b.dataSort));

            const listaHistorico = [
                ...reservasHistorico.map(r => ({...r, tipo: 'reserva', dataSort: r.data + r.horaInicio})),
                ...minhaFilaHistorico.map(f => ({...f, tipo: 'fila', dataSort: f.data + f.horario}))
            ].sort((a, b) => b.dataSort.localeCompare(a.dataSort));

            const lista = tab === 'ativas' ? listaAtivas : listaHistorico;
            const getRecurso = (id) => recursos.find(r => r.id === id);
            const getModulo = (id) => modulos.find(m => m.id === id);

            return (
                <div className="p-4 space-y-4 pb-24">
                    <h2 className="text-xl font-bold text-slate-800">üìÖ Minhas Reservas</h2>
                    <TabBar tabs={[{ id: 'ativas', label: `Ativas (${listaAtivas.length})` }, { id: 'historico', label: `Hist√≥rico (${listaHistorico.length})` }]} active={tab} onChange={setTab} />
                    
                    {lista.length === 0 ? (
                        <Card className="p-8 text-center text-slate-500">
                            <span className="text-4xl block mb-2">{tab === 'ativas' ? 'üåü' : 'üìú'}</span>
                            <p>{tab === 'ativas' ? 'Nada agendado no momento.' : 'Hist√≥rico vazio.'}</p>
                        </Card>
                    ) : (
                        <div className="space-y-3">
                            {lista.map(item => {
                                const isFila = item.tipo === 'fila';
                                const modulo = isFila ? getModulo(item.moduloId) : getModulo(getRecurso(item.recursoId)?.moduloId);
                                const recurso = isFila ? (item.recursoId ? getRecurso(item.recursoId) : null) : getRecurso(item.recursoId);
                                
                                return (
                                    <Card key={item.id} className={`p-4 border-l-4 ${isFila ? 'border-l-purple-500' : 'border-l-teal-500'}`}>
                                        <div className="flex justify-between items-start mb-2">
                                            <div className="flex items-center gap-2">
                                                <span className="text-2xl">{modulo?.icone}</span>
                                                <div>
                                                    <h4 className="font-semibold text-slate-800">{isFila ? `Fila: ${modulo?.nome}` : recurso?.nome}</h4>
                                                    <p className="text-xs text-slate-500">{isFila ? (recurso ? `Local: ${recurso.nome}` : 'Qualquer local livre') : modulo?.nome}</p>
                                                </div>
                                            </div>
                                            {isFila ? <Badge variant="purple" size="sm">Fila</Badge> : <StatusReservaBadge status={item.status} />}
                                        </div>

                                        <div className="bg-slate-50 rounded-lg p-3 text-sm space-y-1">
                                            <div className="flex justify-between">
                                                <span className="text-slate-500">Data:</span>
                                                <span className="font-medium">{formatDateBR(item.data)}</span>
                                            </div>
                                            {isFila ? (
                                                <>
                                                    <div className="flex justify-between">
                                                        <span className="text-slate-500">Hor√°rio Desejado:</span>
                                                        <span className="font-medium">{item.horario}</span>
                                                    </div>
                                                    {tab === 'ativas' && (
                                                        <div className="mt-2 pt-2 border-t border-slate-200 flex justify-between items-center">
                                                            <span className="text-purple-700 font-bold">Sua Posi√ß√£o:</span>
                                                            <span className="text-lg font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full">{getPosicaoFila(item)}¬∫</span>
                                                        </div>
                                                    )}
                                                </>
                                            ) : (
                                                <div className="flex justify-between">
                                                    <span className="text-slate-500">Hor√°rio:</span>
                                                    <span className="font-medium">{item.horaInicio} - {item.horaFim}</span>
                                                </div>
                                            )}
                                        </div>

                                        {tab === 'ativas' && (
                                            <Button variant="danger" size="sm" className="w-full mt-3" onClick={() => isFila ? onCancelarFila(item.id) : onCancelar(item.id)}>
                                                {isFila ? 'Sair da Fila' : 'Cancelar Reserva'}
                                            </Button>
                                        )}
                                    </Card>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // ENTRAR NA FILA
        const TelaEntrarFila = ({ modulo, recursos, user, fila, onEntrar, onVoltar }) => {
            const [tipoEspera, setTipoEspera] = useState('qualquer');
            const [recursoSelecionado, setRecursoSelecionado] = useState(null);
            const [dataSelecionada, setDataSelecionada] = useState(hoje());
            const [horarioSelecionado, setHorarioSelecionado] = useState(null);
            const recursosDisponiveis = recursos.filter(r => r.moduloId === modulo.id && r.status === 'Livre');
            const jaEstaNaFila = horarioSelecionado && fila.some(f => f.usuarioId === user.id && f.moduloId === modulo.id && f.data === dataSelecionada && f.horario === horarioSelecionado && f.status === 'Aguardando');

            const handleConfirmar = () => {
                onEntrar({
                    id: Date.now(),
                    moduloId: modulo.id,
                    recursoId: tipoEspera === 'especifica' ? recursoSelecionado.id : null,
                    usuarioId: user.id,
                    data: dataSelecionada,
                    horario: horarioSelecionado,
                    criadoEm: new Date().toISOString(),
                    status: 'Aguardando',
                    tipoEntrada: modulo.tipo_fila
                });
            };

            return (
                <div className="p-4 space-y-4 pb-24">
                    <button onClick={onVoltar} className="flex items-center gap-2 text-slate-600 font-medium">‚Üê Voltar</button>
                    <div className="flex items-center gap-3">
                        <div className="relative">
                            <span className="text-3xl">{modulo.icone}</span>
                            <span className="absolute -top-1 -right-1 text-lg">‚è≥</span>
                        </div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">Fila de Espera</h2>
                            <p className="text-sm text-slate-500">{modulo.nome}</p>
                        </div>
                    </div>
                    <Card className="p-4 bg-purple-50 border border-purple-200">
                        <p className="text-sm text-purple-700">{modulo.tipo_fila === 'checkin' ? `üìç Check-in presencial - Compare√ßa at√© ${modulo.antecedencia_fila} minutos antes.` : `üìÖ Agendamento - Reserve sua posi√ß√£o na fila.`}</p>
                    </Card>
                    <div className="space-y-3">
                        <h3 className="font-semibold text-slate-700">O que voc√™ prefere?</h3>
                        <Card className={`p-4 border-2 ${tipoEspera === 'qualquer' ? 'border-purple-500 bg-purple-50' : 'border-transparent'}`} onClick={() => { setTipoEspera('qualquer'); setRecursoSelecionado(null); }}>
                            <div className="flex items-center gap-3">
                                <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${tipoEspera === 'qualquer' ? 'border-purple-500' : 'border-slate-300'}`}>{tipoEspera === 'qualquer' && <div className="w-3 h-3 bg-purple-500 rounded-full" />}</div>
                                <div><p className="font-semibold text-slate-800">Qualquer dispon√≠vel</p><p className="text-sm text-slate-500">Primeira que vagar</p></div>
                            </div>
                        </Card>
                        <Card className={`p-4 border-2 ${tipoEspera === 'especifica' ? 'border-purple-500 bg-purple-50' : 'border-transparent'}`} onClick={() => setTipoEspera('especifica')}>
                            <div className="flex items-center gap-3">
                                <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${tipoEspera === 'especifica' ? 'border-purple-500' : 'border-slate-300'}`}>{tipoEspera === 'especifica' && <div className="w-3 h-3 bg-purple-500 rounded-full" />}</div>
                                <div><p className="font-semibold text-slate-800">Espec√≠fica</p><p className="text-sm text-slate-500">Escolher qual prefiro</p></div>
                            </div>
                        </Card>
                    </div>
                    {tipoEspera === 'especifica' && (
                        <div className="space-y-2">
                            <h4 className="text-sm font-medium text-slate-700">Escolha:</h4>
                            {recursosDisponiveis.map(recurso => (
                                <button key={recurso.id} onClick={() => setRecursoSelecionado(recurso)} className={`w-full p-3 rounded-xl text-left transition-all ${recursoSelecionado?.id === recurso.id ? 'bg-purple-100 border-2 border-purple-500' : 'bg-slate-50 border-2 border-transparent'}`}>{recurso.nome}</button>
                            ))}
                        </div>
                    )}
                    {modulo.tipo_fila === 'agendamento' && <Input type="date" label="Data:" value={dataSelecionada} onChange={(e) => setDataSelecionada(e.target.value)} min={hoje()} />}
                    <div className="space-y-2">
                        <h4 className="text-sm font-medium text-slate-700">Hor√°rio desejado:</h4>
                        <div className="grid grid-cols-4 gap-2 max-h-48 overflow-y-auto">
                            {gerarHorarios().map(horario => (
                                <button key={horario} onClick={() => setHorarioSelecionado(horario)} className={`p-2 rounded-xl text-sm font-medium transition-all ${horarioSelecionado === horario ? 'bg-purple-500 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}`}>{horario}</button>
                            ))}
                        </div>
                    </div>
                    {jaEstaNaFila && <div className="bg-amber-50 p-3 rounded-xl text-sm text-amber-700">‚ö†Ô∏è Voc√™ j√° est√° na fila para este hor√°rio!</div>}
                    <Button variant="purple" className="w-full" disabled={!horarioSelecionado || (tipoEspera === 'especifica' && !recursoSelecionado) || jaEstaNaFila} onClick={handleConfirmar}>Entrar na Fila de Espera</Button>
                </div>
            );
        };

        // TELA DE FILA GERAL (VISUALIZA√á√ÉO CORRIGIDA)
        const TelaFilaEspera = ({ modulos, fila, user, onCancelarFila }) => {
            const modulosComFila = modulos.filter(m => m.ativo && m.fila_habilitada);
            const minhaFila = fila.filter(f => f.usuarioId === user.id && f.status === 'Aguardando');

            // CORRE√á√ÉO: Calcula a posi√ß√£o baseada na fila global do m√≥dulo
            const getPosicaoReal = (itemFila) => {
                const filaGeral = fila.filter(f => f.moduloId === itemFila.moduloId && f.status === 'Aguardando').sort((a, b) => new Date(a.criadoEm) - new Date(b.criadoEm));
                return filaGeral.findIndex(f => f.id === itemFila.id) + 1;
            }

            return (
                <div className="p-4 space-y-4 pb-24">
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-xl font-bold text-slate-800">‚è≥ Fila de Espera</h2>
                            <p className="text-sm text-slate-500">Suas posi√ß√µes atuais</p>
                        </div>
                    </div>
                    {minhaFila.length === 0 ? (
                        <Card className="p-8 text-center">
                            <span className="text-4xl mb-4 block">‚è≥</span>
                            <p className="text-slate-500">Voc√™ n√£o est√° em nenhuma fila</p>
                        </Card>
                    ) : (
                        <div className="space-y-3">
                            {minhaFila.map(f => {
                                const modulo = modulos.find(m => m.id === f.moduloId);
                                const posicao = getPosicaoReal(f);
                                return (
                                    <Card key={f.id} className="p-4 border-l-4 border-l-purple-500">
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-700 font-bold text-lg">{posicao}¬∫</div>
                                                <div>
                                                    <h3 className="font-semibold text-slate-800">{modulo?.nome}</h3>
                                                    <p className="text-sm text-slate-500">{f.horario} ‚Ä¢ {formatDateBR(f.data)}</p>
                                                </div>
                                            </div>
                                            <Button variant="danger" size="sm" onClick={() => onCancelarFila(f.id)}>Sair</Button>
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // LOUSA DIGITAL (RESTAURADA)
        const LousaDigital = ({ modulos, recursos, reservas, usuarios, fila, config, onStart, onEncerrar, onEstender, onNoShow, onAprovarPagamento, onAtribuirFila }) => {
            const [moduloFiltro, setModuloFiltro] = useState(null);
            const [, forceUpdate] = useState(0);
            useEffect(() => { const i = setInterval(() => forceUpdate(n => n + 1), 1000); return () => clearInterval(i); }, []);

            const modulosAtivos = modulos.filter(m => m.ativo);
            const recursosExibidos = moduloFiltro ? recursos.filter(r => r.moduloId === moduloFiltro) : recursos.filter(r => modulosAtivos.some(m => m.id === r.moduloId));
            const getModulo = (id) => modulos.find(m => m.id === id);
            const getUsuario = (id) => usuarios.find(u => u.id === id);
            const getReservaAtual = (recursoId) => reservas.find(r => r.recursoId === recursoId && r.data === hoje() && ['Pendente', 'Confirmada', 'Em Andamento', 'Aguardando Pagamento'].includes(r.status));
            const getFilaRecurso = (recurso) => fila.filter(f => f.moduloId === recurso.moduloId && f.status === 'Aguardando' && f.data === hoje() && (f.recursoId === null || f.recursoId === recurso.id)).sort((a, b) => { if (a.recursoId === recurso.id && b.recursoId !== recurso.id) return -1; if (b.recursoId === recurso.id && a.recursoId !== recurso.id) return 1; return new Date(a.criadoEm) - new Date(b.criadoEm); });
            const calcularTempoRestante = (reserva) => { if (!reserva.iniciadaEm) return null; const passado = Math.floor((new Date() - new Date(reserva.iniciadaEm)) / 1000); return Math.max(0, reserva.duracaoTotal * 60 - passado); };
            const getStatusTempo = (reserva) => { if (!reserva.iniciadaEm) return { fase: 'aguardando', tempo: null }; const passadoMin = (new Date() - new Date(reserva.iniciadaEm)) / 60000; return { fase: passadoMin < TEMPO_AQUECIMENTO ? 'aquecimento' : 'jogo', tempo: calcularTempoRestante(reserva) }; };
            const totalFila = fila.filter(f => f.status === 'Aguardando' && f.data === hoje()).length;

            return (
                <div className="p-4 space-y-4 pb-24">
                    <div className="flex items-center justify-between">
                        <div><h2 className="text-xl font-bold text-slate-800">üìã Lousa Digital</h2><p className="text-sm text-slate-500">Controle em tempo real</p></div>
                        <Badge variant="info">{formatDateBR(hoje())}</Badge>
                    </div>
                    <div className="flex gap-2 overflow-x-auto pb-2">
                        <Button variant={!moduloFiltro ? 'primary' : 'secondary'} size="sm" onClick={() => setModuloFiltro(null)}>Todos</Button>
                        {modulosAtivos.map(m => <Button key={m.id} variant={moduloFiltro === m.id ? 'primary' : 'secondary'} size="sm" onClick={() => setModuloFiltro(m.id)}>{m.icone} {m.nome}</Button>)}
                    </div>
                    {totalFila > 0 && (
                        <Card className="p-3 bg-purple-50 border border-purple-200">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2"><span className="text-lg">‚è≥</span><span className="font-medium text-purple-800">{totalFila} pessoa(s) na fila</span></div>
                                <Badge variant="purple">{totalFila}</Badge>
                            </div>
                        </Card>
                    )}
                    <div className="space-y-3">
                        {recursosExibidos.map(recurso => {
                            const modulo = getModulo(recurso.moduloId);
                            const reserva = getReservaAtual(recurso.id);
                            const usuario = reserva ? getUsuario(reserva.usuarioId) : null;
                            const filaRecurso = getFilaRecurso(recurso);
                            const statusTempo = reserva ? getStatusTempo(reserva) : null;
                            const podeUsar = recurso.status === 'Livre';
                            const statusCfg = STATUS_RECURSOS[recurso.status];

                            return (
                                <Card key={recurso.id} className={`p-4 ${!podeUsar ? 'opacity-70' : ''}`}>
                                    <div className="flex items-center justify-between mb-3">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xl">{modulo?.icone}</span>
                                            <div>
                                                <h3 className="font-bold text-slate-800">{recurso.nome}</h3>
                                                <div className="flex items-center gap-2 flex-wrap">
                                                    <StatusRecursoBadge status={recurso.status} size="sm" />
                                                    {filaRecurso.length > 0 && podeUsar && <Badge variant="purple" size="sm">‚è≥ {filaRecurso.length} na fila</Badge>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {!podeUsar ? (
                                        <div className="text-center py-4 rounded-xl bg-slate-100">
                                            <p className="text-lg">{statusCfg.icone}</p>
                                            <p className="font-medium text-slate-700">{statusCfg.label}</p>
                                            {recurso.motivo && <p className="text-xs text-slate-500 mt-1">{recurso.motivo}</p>}
                                        </div>
                                    ) : reserva ? (
                                        <div className="space-y-3">
                                            <div className="bg-slate-50 p-3 rounded-xl">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div>
                                                        <p className="font-semibold text-slate-800">üë§ {usuario?.nome}</p>
                                                        <p className="text-sm text-slate-500">{reserva.horaInicio} - {reserva.horaFim}</p>
                                                    </div>
                                                    <Badge variant={reserva.status === 'Aguardando Pagamento' ? 'purple' : statusTempo?.fase === 'aquecimento' ? 'warning' : statusTempo?.fase === 'jogo' ? 'success' : 'info'}>
                                                        {reserva.status === 'Aguardando Pagamento' ? 'üí∞ Aguardando' : statusTempo?.fase === 'aquecimento' ? 'üî• Aquecimento' : statusTempo?.fase === 'jogo' ? 'üéæ Em Jogo' : '‚è∏Ô∏è Aguardando'}
                                                    </Badge>
                                                </div>
                                                {statusTempo?.tempo !== null && (
                                                    <div className={`text-center py-3 rounded-xl ${statusTempo.tempo < 300 ? 'bg-red-100 animate-timer-warning' : statusTempo.fase === 'aquecimento' ? 'bg-amber-100' : 'bg-emerald-100'}`}>
                                                        <p className={`text-3xl font-bold font-mono ${statusTempo.tempo < 300 ? 'text-red-600 animate-timer' : statusTempo.fase === 'aquecimento' ? 'text-amber-600' : 'text-emerald-600'}`}>{formatarTempo(statusTempo.tempo)}</p>
                                                        <p className="text-xs text-slate-500 mt-1">{statusTempo.fase === 'aquecimento' ? `${TEMPO_AQUECIMENTO} min de aquecimento` : `${modulo?.duracao || 60} min de jogo`}</p>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex gap-2 flex-wrap">
                                                {reserva.status === 'Aguardando Pagamento' && <Button variant="success" size="sm" className="flex-1" onClick={() => onAprovarPagamento(reserva.id)}>üí∞ Aprovar Pagamento</Button>}
                                                {reserva.status === 'Pendente' && (
                                                    <>
                                                        <Button variant="success" size="sm" className="flex-1" onClick={() => onStart(reserva.id)}>‚ñ∂Ô∏è START</Button>
                                                        <Button variant="danger" size="sm" onClick={() => onNoShow(reserva.id)}>No-Show</Button>
                                                    </>
                                                )}
                                                {reserva.status === 'Em Andamento' && (
                                                    <>
                                                        <Button variant="blue" size="sm" onClick={() => onEstender(reserva.id)}>+1 hora</Button>
                                                        <Button variant="danger" size="sm" className="flex-1" onClick={() => onEncerrar(reserva.id)}>Encerrar</Button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-6 bg-emerald-50 rounded-xl">
                                            <p className="text-2xl mb-1">‚úì</p>
                                            <p className="text-emerald-700 font-medium">Livre</p>
                                            {filaRecurso.length > 0 && <Button variant="purple" size="sm" className="mt-3" onClick={() => onAtribuirFila(filaRecurso[0], recurso)}>Chamar da Fila</Button>}
                                        </div>
                                    )}
                                    {filaRecurso.length > 0 && podeUsar && (
                                        <div className="mt-3 pt-3 border-t border-slate-100">
                                            <p className="text-xs font-semibold text-purple-700 mb-2">‚è≥ Pr√≥ximos na fila:</p>
                                            <div className="space-y-1">
                                                {filaRecurso.slice(0, 3).map((f, i) => {
                                                    const u = getUsuario(f.usuarioId);
                                                    return (
                                                        <div key={f.id} className="flex items-center justify-between bg-purple-50 p-2 rounded-lg">
                                                            <div className="flex items-center gap-2 text-sm">
                                                                <span className="w-5 h-5 bg-purple-200 rounded-full flex items-center justify-center text-purple-700 text-xs font-bold">{i + 1}</span>
                                                                <span className="text-slate-700">{u?.nome}</span>
                                                                <span className="text-slate-400">‚Ä¢ {f.horario}</span>
                                                            </div>
                                                            <Button variant="success" size="sm" onClick={() => onAtribuirFila(f, recurso)}>Chamar</Button>
                                                        </div>
                                                    );
                                                })}
                                                {filaRecurso.length > 3 && <p className="text-xs text-slate-400 text-center">+{filaRecurso.length - 3} mais...</p>}
                                            </div>
                                        </div>
                                    )}
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // PAINEL DE CONFIGURA√á√ïES
        const PainelConfig = ({ currentUser, config, modulos, recursos, usuarios, aulas, onUpdateConfig, onUpdateModulo, onAddRecurso, onUpdateRecurso, onDeleteRecurso, onAddAula, onDeleteAula, onUpdateAula, onAddUsuario, onUpdateUsuario }) => {
            const isAdmin = currentUser.role === 'Admin';
            const tabsDisponiveis = isAdmin 
                ? [{ id: 'recursos', label: 'Quadras' }, { id: 'aulas', label: 'Aulas' }, { id: 'modulos', label: 'M√≥dulos' }, { id: 'fila', label: 'Fila' }, { id: 'clube', label: 'Clube' }, { id: 'usuarios', label: 'Usu√°rios' }]
                : [{ id: 'usuarios', label: 'Gest√£o S√≥cios' }];

            const [tab, setTab] = useState(isAdmin ? 'recursos' : 'usuarios');
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [senha, setSenha] = useState('');
            
            // Modais
            const [modalRecurso, setModalRecurso] = useState(null);
            const [modalStatus, setModalStatus] = useState(null);
            const [modalModulo, setModalModulo] = useState(null);
            const [modalAula, setModalAula] = useState(null);
            const [modalUsuario, setModalUsuario] = useState(null);

            if (!isUnlocked) {
                return (
                    <div className="p-4 pb-24">
                        <Card className="p-6 text-center max-w-sm mx-auto">
                            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><span className="text-2xl">üîí</span></div>
                            <h3 className="text-lg font-bold text-slate-800 mb-2">√Årea Restrita</h3>
                            <Input type="password" placeholder="Senha de acesso" value={senha} onChange={(e) => setSenha(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && senha === '1234' && setIsUnlocked(true)} />
                            <Button className="w-full mt-4" onClick={() => senha === '1234' && setIsUnlocked(true)}>Acessar</Button>
                        </Card>
                    </div>
                );
            }

            const toggleDiaAula = (id) => {
                if (!modalAula) return;
                const diasAtuais = modalAula.diasSemana || [];
                if (diasAtuais.includes(id)) {
                    setModalAula({ ...modalAula, diasSemana: diasAtuais.filter(d => d !== id) });
                } else {
                    setModalAula({ ...modalAula, diasSemana: [...diasAtuais, id].sort() });
                }
            };

            return (
                <div className="p-4 space-y-4 pb-24">
                    <h2 className="text-xl font-bold text-slate-800">‚öôÔ∏è Configura√ß√µes</h2>
                    <TabBar tabs={tabsDisponiveis} active={tab} onChange={setTab} />

                    {isAdmin && tab === 'recursos' && (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center"><p className="text-sm text-slate-500">Gerenciar recursos</p><Button size="sm" onClick={() => setModalRecurso({ id: null, moduloId: 1, nome: '', capacidade: 4, status: 'Livre' })}>+ Novo</Button></div>
                            {modulos.filter(m => m.ativo).map(mod => {
                                const recs = recursos.filter(r => r.moduloId === mod.id);
                                return (
                                    <Card key={mod.id} className="p-4">
                                        <div className="flex items-center gap-2 mb-3"><span className="text-2xl">{mod.icone}</span><h3 className="font-semibold text-slate-800">{mod.nome}</h3></div>
                                        <div className="space-y-2">
                                            {recs.map(recurso => (
                                                <div key={recurso.id} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                                    <div><p className="font-medium text-slate-800">{recurso.nome}</p><div className="flex items-center gap-2 mt-1"><StatusRecursoBadge status={recurso.status} size="sm" /></div></div>
                                                    <div className="flex gap-1"><Button variant="ghost" size="sm" onClick={() => setModalStatus(recurso)}>Status</Button><Button variant="ghost" size="sm" onClick={() => setModalRecurso(recurso)}>Editar</Button><Button variant="ghost" size="sm" onClick={() => onDeleteRecurso(recurso.id)}>üóëÔ∏è</Button></div>
                                                </div>
                                            ))}
                                        </div>
                                    </Card>
                                );
                            })}
                        </div>
                    )}

                    {isAdmin && tab === 'aulas' && (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center"><Button size="sm" onClick={() => setModalAula({ id: null, recursoId: recursos[0]?.id || 1, diasSemana: [1], horaInicio: '18:00', horaFim: '19:00', professor: '', nome: '', status: 'ativo' })}>+ Nova Aula</Button></div>
                            <div className="space-y-2">
                                {aulas.map(aula => {
                                    const recurso = recursos.find(r => r.id === aula.recursoId);
                                    const isCancelled = aula.status === 'cancelada';
                                    return (
                                        <Card key={aula.id} className={`p-3 ${isCancelled ? 'opacity-60 bg-slate-50' : ''}`}>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <div className="flex items-center gap-2"><h4 className={`font-bold ${isCancelled ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{aula.nome} <span className="font-normal text-slate-500">({aula.professor})</span></h4>{isCancelled && <Badge variant="danger" size="sm">Cancelada</Badge>}</div>
                                                    <p className="text-sm text-slate-600 font-medium">{formatDiasSemana(aula.diasSemana)}</p>
                                                    <p className="text-xs text-slate-500">{aula.horaInicio} √†s {aula.horaFim} ‚Ä¢ {recurso?.nome}</p>
                                                </div>
                                                <div className="flex gap-1"><Button variant="ghost" size="sm" onClick={() => setModalAula(aula)}>Editar</Button><Button variant="ghost" size="sm" onClick={() => onDeleteAula(aula.id)}>üóëÔ∏è</Button></div>
                                            </div>
                                        </Card>
                                    )
                                })}
                            </div>
                        </div>
                    )}

                    {isAdmin && tab === 'modulos' && (
                        <div className="space-y-3">{modulos.map(mod => (<Card key={mod.id} className="p-4"><div className="flex items-center justify-between"><div className="flex items-center gap-3"><span className="text-2xl">{mod.icone}</span><div><h3 className="font-semibold text-slate-800">{mod.nome}</h3></div></div><div className="flex items-center gap-2"><Button variant="ghost" size="sm" onClick={() => setModalModulo(mod)}>Editar</Button><Toggle checked={mod.ativo} onChange={(v) => onUpdateModulo(mod.id, { ativo: v })} /></div></div></Card>))}</div>
                    )}

                    {isAdmin && tab === 'fila' && (
                        <div className="space-y-3">{modulos.filter(m => m.gratuito).map(mod => (<Card key={mod.id} className="p-4"><div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><span className="text-xl">{mod.icone}</span><h3 className="font-semibold text-slate-800">{mod.nome}</h3></div><Toggle checked={mod.fila_habilitada} onChange={(v) => onUpdateModulo(mod.id, { fila_habilitada: v })} /></div>{mod.fila_habilitada && (<div className="space-y-3 pt-3 border-t border-slate-100"><Input type="number" label="Anteced√™ncia m√≠nima (minutos)" value={mod.antecedencia_fila} onChange={(e) => onUpdateModulo(mod.id, { antecedencia_fila: parseInt(e.target.value) || 0 })} min="0" /></div>)}</Card>))}</div>
                    )}

                    {isAdmin && tab === 'clube' && (
                        <Card className="p-4 space-y-4"><Input label="Nome do Clube" value={config.nome_clube} onChange={(e) => onUpdateConfig({ nome_clube: e.target.value })} /><Input label="Chave PIX" value={config.pix_chave} onChange={(e) => onUpdateConfig({ pix_chave: e.target.value })} /></Card>
                    )}

                    {tab === 'usuarios' && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center"><p className="text-sm text-slate-500">{usuarios.length} usu√°rios</p>{isAdmin && <Button size="sm" onClick={() => setModalUsuario({ id: null, nome: '', matricula: '', senha: '1234', role: 'Socio', status: 'Ativo' })}>+ Novo</Button>}</div>
                            {usuarios.map(u => (
                                <Card key={u.id} className="p-4 border-l-4 border-l-transparent hover:border-l-teal-500">
                                    <div className="flex items-center justify-between">
                                        <div><div className="flex items-center gap-2"><h4 className="font-semibold text-slate-800">{u.nome}</h4>{u.status === 'Cancelado' && <Badge variant="danger" size="sm">Cancelado</Badge>}{u.status === 'Bloqueado' && <Badge variant="warning" size="sm">Bloqueado</Badge>}</div><p className="text-sm text-slate-500">{u.matricula} ‚Ä¢ {u.role}</p></div>
                                        <Button variant="secondary" size="sm" onClick={() => setModalUsuario(u)}>Editar</Button>
                                    </div>
                                </Card>
                            ))}
                        </div>
                    )}

                    {/* MODAIS RESTAURADOS COMPLETOS */}
                    <Modal isOpen={!!modalUsuario} onClose={() => setModalUsuario(null)} title={modalUsuario?.id ? "Editar Usu√°rio" : "Novo Usu√°rio"}>
                        {modalUsuario && (
                            <div className="space-y-4">
                                <Input label="Nome" value={modalUsuario.nome} onChange={(e) => setModalUsuario({...modalUsuario, nome: e.target.value})} disabled={!isAdmin} />
                                <Input label="Matr√≠cula" value={modalUsuario.matricula} onChange={(e) => setModalUsuario({...modalUsuario, matricula: e.target.value})} disabled={!isAdmin} />
                                {isAdmin && <Input label="Senha" value={modalUsuario.senha} onChange={(e) => setModalUsuario({...modalUsuario, senha: e.target.value})} />}
                                {isAdmin && <Select label="Tipo" options={[{value: 'Socio', label: 'S√≥cio'}, {value: 'Funcionario', label: 'Funcion√°rio'}, {value: 'Admin', label: 'Administrador'}]} value={modalUsuario.role} onChange={(e) => setModalUsuario({...modalUsuario, role: e.target.value})} />}
                                <div className="space-y-2"><label className="text-sm font-medium text-slate-700">Status:</label><div className="grid grid-cols-3 gap-2"><button onClick={() => setModalUsuario({...modalUsuario, status: 'Ativo', bloqueado_ate: null})} className={`p-2 rounded-lg text-sm border-2 ${modalUsuario.status === 'Ativo' ? 'border-emerald-500 bg-emerald-50 text-emerald-700 font-bold' : 'border-slate-100'}`}>Ativo</button><button onClick={() => setModalUsuario({...modalUsuario, status: 'Bloqueado', bloqueado_ate: formatDate(addDays(new Date(), 7))})} className={`p-2 rounded-lg text-sm border-2 ${modalUsuario.status === 'Bloqueado' ? 'border-amber-500 bg-amber-50' : 'border-slate-100'}`}>Bloqueado</button><button onClick={() => setModalUsuario({...modalUsuario, status: 'Cancelado'})} className={`p-2 rounded-lg text-sm border-2 ${modalUsuario.status === 'Cancelado' ? 'border-red-500 bg-red-50' : 'border-slate-100'}`}>Cancelado</button></div></div>
                                <Button className="w-full mt-4" onClick={() => { if (modalUsuario.id) onUpdateUsuario(modalUsuario.id, modalUsuario); else onAddUsuario({...modalUsuario, id: Date.now(), noshow_count: 0}); setModalUsuario(null); }}>Salvar</Button>
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={!!modalRecurso} onClose={() => setModalRecurso(null)} title={modalRecurso?.id ? 'Editar Recurso' : 'Novo Recurso'}>
                        {modalRecurso && (
                            <div className="space-y-4">
                                <Select label="M√≥dulo" options={modulos.filter(m => m.ativo).map(m => ({ value: m.id, label: `${m.icone} ${m.nome}` }))} value={modalRecurso.moduloId} onChange={(e) => setModalRecurso({ ...modalRecurso, moduloId: parseInt(e.target.value) })} />
                                <Input label="Nome" placeholder="Ex: Quadra 01" value={modalRecurso.nome} onChange={(e) => setModalRecurso({ ...modalRecurso, nome: e.target.value })} />
                                <Input type="number" label="Capacidade" value={modalRecurso.capacidade} onChange={(e) => setModalRecurso({ ...modalRecurso, capacidade: parseInt(e.target.value) || 4 })} min="1" />
                                <Button className="w-full" onClick={() => { if (modalRecurso.id) { onUpdateRecurso(modalRecurso.id, modalRecurso); } else { onAddRecurso({ ...modalRecurso, id: Date.now() }); } setModalRecurso(null); }}>Salvar</Button>
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={!!modalAula} onClose={() => setModalAula(null)} title={modalAula?.id ? "Editar Aula" : "Nova Aula"}>
                        {modalAula && (
                            <div className="space-y-4">
                                <Input label="Nome" value={modalAula.nome} onChange={(e) => setModalAula({ ...modalAula, nome: e.target.value })} />
                                <Input label="Professor" value={modalAula.professor} onChange={(e) => setModalAula({ ...modalAula, professor: e.target.value })} />
                                <Select label="Local" options={recursos.map(r => ({ value: r.id, label: r.nome }))} value={modalAula.recursoId} onChange={(e) => setModalAula({ ...modalAula, recursoId: parseInt(e.target.value) })} />
                                <Select label="Status" options={[{value: 'ativo', label: 'Ativa'}, {value: 'cancelada', label: 'Cancelada'}]} value={modalAula.status || 'ativo'} onChange={(e) => setModalAula({ ...modalAula, status: e.target.value })} />
                                <div className="space-y-2"><label className="text-sm font-medium text-slate-700">Dias:</label><div className="flex gap-2 justify-between">{DIAS_SEMANA.map(dia => { const isSelected = modalAula.diasSemana?.includes(dia.id); return (<button key={dia.id} onClick={() => toggleDiaAula(dia.id)} className={`w-8 h-8 rounded-full font-bold text-xs transition-all flex items-center justify-center ${isSelected ? 'bg-teal-600 text-white' : 'bg-slate-100 text-slate-500'}`}>{dia.curto[0]}</button>); })}</div></div>
                                <div className="flex gap-2"><Input type="time" label="In√≠cio" value={modalAula.horaInicio} onChange={(e) => setModalAula({ ...modalAula, horaInicio: e.target.value })} /><Input type="time" label="Fim" value={modalAula.horaFim} onChange={(e) => setModalAula({ ...modalAula, horaFim: e.target.value })} /></div>
                                <Button className="w-full" onClick={() => { if (modalAula.id) { onUpdateAula(modalAula.id, modalAula); } else { onAddAula({ ...modalAula, id: Date.now(), status: 'ativo' }); } setModalAula(null); }}>Salvar</Button>
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={!!modalModulo} onClose={() => setModalModulo(null)} title={`Editar ${modalModulo?.nome}`}>
                        {modalModulo && (
                            <div className="space-y-4">
                                <Input type="number" label="Valor (R$)" value={modalModulo.valor} onChange={(e) => setModalModulo({ ...modalModulo, valor: parseFloat(e.target.value) || 0 })} min="0" />
                                <Select label="Dura√ß√£o" options={[{ value: '30', label: '30 min' }, { value: '60', label: '1 h' }, { value: '90', label: '1h30' }]} value={String(modalModulo.duracao)} onChange={(e) => setModalModulo({ ...modalModulo, duracao: parseInt(e.target.value) })} />
                                <Button className="w-full" onClick={() => { onUpdateModulo(modalModulo.id, modalModulo); setModalModulo(null); }}>Salvar</Button>
                            </div>
                        )}
                    </Modal>

                    <Modal isOpen={!!modalStatus} onClose={() => setModalStatus(null)} title={`Status - ${modalStatus?.nome}`}>
                        {modalStatus && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 gap-2">{Object.entries(STATUS_RECURSOS).map(([key, cfg]) => (<button key={key} onClick={() => setModalStatus({ ...modalStatus, status: key })} className={`p-3 rounded-xl text-left border-2 ${modalStatus.status === key ? 'border-teal-500 bg-teal-50' : 'border-transparent bg-slate-50'}`}><span className="mr-2">{cfg.icone}</span><span className="font-medium">{cfg.label}</span></button>))}</div>
                                {['Manutencao', 'Reservada', 'Interditada'].includes(modalStatus.status) && (<Textarea label="Motivo" value={modalStatus.motivo || ''} onChange={(e) => setModalStatus({ ...modalStatus, motivo: e.target.value })} />)}
                                <Button className="w-full" onClick={() => { onUpdateRecurso(modalStatus.id, { status: modalStatus.status, motivo: ['Manutencao', 'Reservada', 'Interditada'].includes(modalStatus.status) ? modalStatus.motivo : null }); setModalStatus(null); }}>Salvar</Button>
                            </div>
                        )}
                    </Modal>
                </div>
            );
        };

        // =============================================
        // APP PRINCIPAL
        // =============================================
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('home');
            const [selectedModulo, setSelectedModulo] = useState(null);
            const [moduloParaFila, setModuloParaFila] = useState(null);
            const [config, setConfig] = useState(initialConfig);
            const [modulos, setModulos] = useState(initialModulos);
            const [recursos, setRecursos] = useState(initialRecursos);
            const [usuarios, setUsuarios] = useState(initialUsuarios);
            const [reservas, setReservas] = useState([]);
            const [aulas, setAulas] = useState(initialAulas);
            const [fila, setFila] = useState([]);
            const [notif, setNotif] = useState(null);
            const notify = (message, type = 'success') => setNotif({ message, type });

            // HANDLERS RESERVA
            const handleReservar = (r) => { setReservas([...reservas, r]); setSelectedModulo(null); notify(r.status === 'Pendente' ? 'Check-in realizado! ‚úì' : 'Reserva realizada! ‚úì'); setView('reservas'); };
            const handleCancelarReserva = (id) => { setReservas(reservas.map(r => r.id === id ? { ...r, status: 'Cancelada' } : r)); notify('Reserva cancelada.', 'warning'); };
            const handleStart = (id) => { setReservas(reservas.map(r => r.id === id ? { ...r, status: 'Em Andamento', iniciadaEm: new Date().toISOString() } : r)); notify('‚è±Ô∏è Tempo iniciado! Bom jogo!'); };
            const handleEncerrar = (id) => { setReservas(reservas.map(r => r.id === id ? { ...r, status: 'Finalizada' } : r)); notify('Reserva encerrada.'); };
            const handleEstender = (id) => { setReservas(reservas.map(r => { if (r.id !== id) return r; const novaDuracao = r.duracaoTotal + TEMPO_EXTENSAO; return { ...r, duracaoTotal: novaDuracao, horaFim: calcularHoraFim(r.horaInicio, novaDuracao) }; })); notify(`+${TEMPO_EXTENSAO} minutos adicionados! ‚è±Ô∏è`); };
            const handleNoShow = (id) => {
                const reserva = reservas.find(r => r.id === id);
                if (!reserva) return;
                setReservas(reservas.map(r => r.id === id ? { ...r, status: 'No-Show' } : r));
                setUsuarios(usuarios.map(u => {
                    if (u.id !== reserva.usuarioId) return u;
                    const novoCount = u.noshow_count + 1;
                    return { ...u, noshow_count: novoCount, bloqueado_ate: novoCount >= config.punicao_noshow_limite ? formatDate(addDays(new Date(), config.punicao_dias_bloqueio)) : u.bloqueado_ate, status: novoCount >= config.punicao_noshow_limite ? 'Bloqueado' : u.status };
                }));
                notify('No-Show registrado.', 'warning');
            };
            const handleAprovarPagamento = (id) => { setReservas(reservas.map(r => r.id === id ? { ...r, status: 'Pendente' } : r)); notify('üí∞ Pagamento aprovado!'); };

            // HANDLERS FILA
            const handleEntrarFila = (f) => { setFila([...fila, f]); setModuloParaFila(null); notify('Voc√™ entrou na fila! ‚è≥'); setView('fila'); };
            const handleCancelarFila = (id) => { setFila(fila.filter(f => f.id !== id)); notify('Saiu da fila.', 'warning'); };
            const handleAdicionarFila = (f) => { setFila([...fila, f]); notify('Pessoa adicionada √† fila!'); };
            const handleAtribuirFila = (entradaFila, recurso) => {
                const modulo = modulos.find(m => m.id === entradaFila.moduloId);
                const recursoAtribuido = recurso || recursos.find(r => r.id === entradaFila.recursoId) || recursos.find(r => r.moduloId === entradaFila.moduloId && r.status === 'Livre');
                if (!recursoAtribuido || recursoAtribuido.status !== 'Livre') { notify('Nenhum recurso dispon√≠vel!', 'error'); return; }
                const duracao = typeof modulo.duracao === 'number' ? modulo.duracao + TEMPO_AQUECIMENTO : 480;
                setReservas([...reservas, { id: Date.now(), recursoId: recursoAtribuido.id, usuarioId: entradaFila.usuarioId, data: entradaFila.data, horaInicio: entradaFila.horario, horaFim: calcularHoraFim(entradaFila.horario, duracao), status: 'Pendente', comprovante_url: null, valor: 0, iniciadaEm: null, duracaoTotal: duracao, criadaEm: new Date().toISOString() }]);
                setFila(fila.map(f => f.id === entradaFila.id ? { ...f, status: 'Atendido' } : f));
                notify(`Reserva criada! ‚úì`);
            };

            // HANDLERS CONFIG
            const handleUpdateConfig = (u) => { setConfig({ ...config, ...u }); notify('Configura√ß√µes atualizadas!'); };
            const handleUpdateModulo = (id, u) => setModulos(modulos.map(m => m.id === id ? { ...m, ...u } : m));
            const handleAddRecurso = (r) => { setRecursos([...recursos, r]); notify('Recurso criado!'); };
            const handleUpdateRecurso = (id, u) => { setRecursos(recursos.map(r => r.id === id ? { ...r, ...u } : r)); notify('Recurso atualizado!'); };
            const handleDeleteRecurso = (id) => { setRecursos(recursos.filter(r => r.id !== id)); notify('Recurso removido.', 'warning'); };
            const handleAddAula = (a) => { setAulas([...aulas, a]); notify('Aula programada!'); };
            const handleDeleteAula = (id) => { setAulas(aulas.filter(a => a.id !== id)); notify('Aula removida.', 'warning'); };
            const handleUpdateAula = (id, u) => { setAulas(aulas.map(a => a.id === id ? { ...a, ...u } : a)); notify('Aula atualizada!'); };
            const handleAddUsuario = (u) => { setUsuarios([...usuarios, u]); notify('Usu√°rio criado!'); };
            const handleUpdateUsuario = (id, u) => { setUsuarios(usuarios.map(usr => usr.id === id ? { ...usr, ...u } : usr)); notify('Usu√°rio atualizado!'); };

            const handleNavigate = (v) => { setView(v); setSelectedModulo(null); setModuloParaFila(null); };
            const handleVoltar = () => { setSelectedModulo(null); setModuloParaFila(null); };

            if (!user) return <TelaLogin usuarios={usuarios} onLogin={setUser} />;
            const userAtualizado = usuarios.find(u => u.id === user.id) || user;

            return (
                <div className="min-h-screen bg-slate-50">
                    <Header user={userAtualizado} onLogout={() => { setUser(null); handleNavigate('home'); }} />
                    <main className="max-w-7xl mx-auto">
                        {view === 'home' && !selectedModulo && !moduloParaFila && <HomeSocio modulos={modulos} recursos={recursos} user={userAtualizado} config={config} onSelectModulo={setSelectedModulo} />}
                        {view === 'home' && selectedModulo && !moduloParaFila && <TelaReserva modulo={selectedModulo} recursos={recursos} reservas={reservas} aulas={aulas} user={userAtualizado} config={config} onReservar={handleReservar} onVoltar={handleVoltar} onEntrarFila={setModuloParaFila} />}
                        {moduloParaFila && <TelaEntrarFila modulo={moduloParaFila} recursos={recursos} user={userAtualizado} fila={fila} onEntrar={handleEntrarFila} onVoltar={handleVoltar} />}
                        {view === 'reservas' && <MinhasReservas reservas={reservas} fila={fila} recursos={recursos} modulos={modulos} user={userAtualizado} onCancelar={handleCancelarReserva} onCancelarFila={handleCancelarFila} />}
                        {view === 'fila' && <TelaFilaEspera modulos={modulos} fila={fila} user={userAtualizado} onCancelarFila={handleCancelarFila} />}
                        {view === 'lousa' && userAtualizado.role !== 'Socio' && <LousaDigital modulos={modulos} recursos={recursos} reservas={reservas} usuarios={usuarios} fila={fila} config={config} onStart={handleStart} onEncerrar={handleEncerrar} onEstender={handleEstender} onNoShow={handleNoShow} onAprovarPagamento={handleAprovarPagamento} onAtribuirFila={handleAtribuirFila} />}
                        {view === 'config' && (userAtualizado.role === 'Admin' || userAtualizado.role === 'Funcionario') && <PainelConfig currentUser={userAtualizado} config={config} modulos={modulos} recursos={recursos} usuarios={usuarios} aulas={aulas} onUpdateConfig={handleUpdateConfig} onUpdateModulo={handleUpdateModulo} onAddRecurso={handleAddRecurso} onUpdateRecurso={handleUpdateRecurso} onDeleteRecurso={handleDeleteRecurso} onAddAula={handleAddAula} onDeleteAula={handleDeleteAula} onUpdateAula={handleUpdateAula} onAddUsuario={handleAddUsuario} onUpdateUsuario={handleUpdateUsuario} />}
                    </main>
                    <BottomNav view={view} onNavigate={handleNavigate} role={userAtualizado.role} />
                    {notif && <Notification {...notif} onClose={() => setNotif(null)} />}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
